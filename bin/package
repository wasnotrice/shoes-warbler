#!/usr/bin/env ruby

require 'rubygems'
require 'yaml'
require 'warbler'

module Shoes
  module Swt
    module Package
      class Jar
        def initialize(config_file)
          app = {
            name: 'Shoes App',
            ignore: []
          }
          if File.exist?(config_file)
            puts "Using config file: #{config_file}"
            app.update YAML.load(File.read config_file)
          end
          app['shortname'] ||= app['name'].downcase.gsub(/\W+/, '')

          @config = Warbler::Config.new do |c|
            c.jar_name = app['shortname']
            c.pathmaps.application = ['shoes-app/%p']
            c.excludes += FileList[*Array(app['ignore'])].pathmap(c.pathmaps.application.first)
          end

          @jar = Warbler::Jar.new
        end

        def config
          @jar.apply(@config)
          # Not sure why Warbler doesn't do this automatically
          @jar.files.delete_if { |k, v| @config.excludes.include? k }
        end

        def create
          jar_filename = "#{@config.jar_name}.#{@config.jar_extension}"
          @jar.create(@config)
        end
      end
    end
  end
end

jar = Shoes::Swt::Package::Jar.new(File.expand_path '../../app.yaml', __FILE__)
jar.config
jar.create

