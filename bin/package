#!/usr/bin/env ruby

require 'rubygems'
require 'yaml'
require 'warbler'

module Shoes
  module Swt
    module Package
      class Jar
        def initialize(config_file)
          app = {}
          if File.exist?(config_file)
            puts "Using config file: #{config_file}"
            app = YAML.load(File.read config_file)
          end

          @config = Warbler::Config.new do |c|
            c.jar_name = app['name'] if app['name']
            c.excludes += FileList[*app['excludes']].pathmap(c.pathmaps.application.first)
          end

          @jar = Warbler::Jar.new
        end

        def config
          @jar.apply(@config)
          @jar.files.delete_if { |k, v| @config.excludes.include? k }
        end

        def create
          jar_filename = "#{@config.jar_name}.#{@config.jar_extension}"
          rm jar_filename if File.exist?(jar_filename)
          @jar.create(@config)
        end
      end
    end
  end
end

jar = Shoes::Swt::Package::Jar.new(File.expand_path '../../app.yaml', __FILE__)
jar.config
jar.create

